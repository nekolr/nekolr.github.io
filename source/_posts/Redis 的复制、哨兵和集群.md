---
title: Redis 的复制、哨兵和集群
date: 2019/9/21 15:10:0
tags: [Redis]
categories: [Redis]
---

在 Redis 中，复制功能的主要作用是实现数据备份，TODO

<!--more-->

# Redis 复制
Redis 基础的复制功能允许一个 Redis 服务去复制另一个 Redis 服务，被复制的服务称为主服务（master），对主服务进行复制的称为从服务（slave）。从服务作为主服务的精确备份，即使因为网络问题等原因导致主从连接断开，从服务也会不断尝试重连，并在重新建立连接后继续进行复制操作。

假设现在有两个 Redis 服务，分别为 `127.0.0.1:6379` 和 `127.0.0.1:12345`，如果向服务 `127.0.0.1:12345` 发送以下命令：

```bash
127.0.0.1:12345> SLAVEOF 127.0.0.1 6379
```

那么服务 `127.0.0.1:12345` 将成为 `127.0.0.1:6379` 的从服务，而 `127.0.0.1:6379` 将成为 `127.0.0.1:12345` 的主服务。

## 复制的实现
**Redis 的复制功能分为同步（sync）和命令传播（command propagate）两个操作。**同步操作用于将从服务的状态更新至主服务当前的状态。命令传播操作则用于当主服务状态被修改后，主从服务出现状态不一致时，让从服务重新回到一致的状态。

当客户端向从服务发送 SLAVEOF 命令，要求从服务复制主服务时，从服务首先要做的就是将客户端给定的主服务的 IP 地址和端口号保存。SLAVEOF 命令是一个异步命令，在完成保存后从服务会向客户端返回 OK，表示复制命令已被接收，而实际的复制工作将在返回 OK 后才开始真正执行。

接着从服务将根据设置的主服务的 IP 地址和端口号，创建一个连向主服务的套接字连接。如果连接成功，那么从服务将会为这个套接字关联一个专门用于处理复制工作的文件事件处理器，比如接收 RDB 文件以及主服务传播过来的写命令等。而主服务将会为该套接字创建相应的客户端状态，将从服务看作是一个连接主服务的客户端，这时从服务将同时具有服务端（server）和客户端（client）两个身份：从服务可以向主服务发送命令请求，而主服务可以向从服务返回命令回复。

从服务成为主服务的客户端之后会向主服务发送一个 PING 命令，一个目的是检查套接字的读写状态是否正常，另一个目的是检查主服务能否正常处理命令请求。如果网络不佳或者主服务返回错误，则从服务会断开并重新创建连向主服务的套接字；如果从服务收到 PONG 回复，则表示主服务当前可以正常处理从服务的命令请求。

接下来就是身份验证阶段，如果主服务设置了 requirepass 选项，那么从服务必须设置 masterauth 选项（也就是密码），没有提供密码或者密码错误都会返回错误；如果主服务没有设置 requirepass 选项，从服务设置 masterauth 同样会返回错误。所有的错误都会使从服务终止当前的复制工作，直到身份验证通过。

身份验证通过后，从服务将执行 `REPLCONF listening-port <port-number>` 命令，向主服务发送从服务的监听端口号，主服务会将该端口号记录在从服务所对应的客户端状态的 slave_listening_port 属性中。

接下来就是真正进行同步的阶段，从服务会向主服务发送 PSYNC 命令进行同步，如果是初次同步，则使用完整重同步模式进行复制。值得一提的是，在同步操作执行之前，只有从服务是主服务的客户端，但是在执行同步操作之后，主服务也会成为从服务的客户端。正是因为这样，主服务才可以发送写命令来改变从服务的状态，这也是主服务对从服务进行命令传播的基础。

> **PSYNC 命令具有完整重同步（full resynchronization）和部分重同步（partial resynchronization）两种模式。**完整重同步用于处理初次复制的情况，收到该命令的主服务会执行 BGSAVE 命令，在后台生成一个 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令，当主服务的 BGSAVE 命令执行完毕后，主服务会将生成的 RDB 文件发送给从服务，从服务接收并载入这个 RDB 文件，从而将数据库的状态更新至主服务执行 BGSAVE 命令时的状态。接着主服务会将记录在缓冲区的所有写命令发送给从服务，从服务执行这些写命令，将数据库更新至主服务当前的状态。部分重同步则用于处理在**命令传播阶段**，主从发生断连后重复制的情况，当从服务在断线后重新连接主服务时，如果条件允许，主服务可以将断开期间执行的写命令发送给从服务，而不必重新进行完整重同步。

当完成了同步之后，主从服务就进入了命令传播阶段，此时主服务只要一直将自己执行的写命令发送给从服务，而从服务只要一直接收并执行主服务发来的写命令，这样主从就可以一直保持一致了。

## 部分重同步的实现
部分重同步的重点包括复制偏移量（replication offset）、复制积压缓冲区（replication backlog）和运行 ID（run ID）。

## 心跳检测
在命令传播阶段，心跳检测用于检测主从之前的网络连接状态、辅助实现 min-slaves 选项以及检测命令丢失。

