---
title: 深入 HTTPS
date: 2023/03/30 11:35:0
tags: [HTTPS]
categories: [安全]
---

一直以来对于 HTTPS 的运行机制一知半解，平常的工作和生活中也只是使用它，很少有机会深入了解它。最近 ChatGPT 大火，在体验了一段时间之后，反而意外地想静下心来学习和整理一番。

<!--more-->

# HTTP 为什么不安全
由于 HTTP 采用明文传输，明文数据经过中间代理服务器、路由器、运营商等多个网络节点，如果信息在传输过程中被劫持，传输的内容就完全暴露了。劫持者可以**窃听**、**篡改**传输的内容，甚至**冒充**通信双方的身份且不被双方察觉，也就是所谓的中间人攻击（MITM）。

# 使用对称加密
既然传输内容是明文的，那我们很容易就能想到对传输内容进行加密。对称加密速度快，性能好，如果通信双方都知道该密钥，且没有任何第三方知道，那么通信当然是安全的。但是如何让通信的双方都知道该密钥呢？浏览器预存所有网站的密钥？这不现实。服务器通过网络传输密钥给浏览器？如果传输过程中被第三方劫持获取到了该密钥，那么之后双方所有的通信内容都能被解密。

# 使用非对称加密
既然对称加密行不通，那么非对称加密呢？由于非对称加密的机制，我们可能会有以下思路：服务器明文传输公钥给浏览器，之后浏览器向服务器传输数据之前都会先用该公钥加密后再传输，只有服务器的私钥能解密该数据。但是反过来，服务器向浏览器传输数据，只能用私钥加密数据，浏览器可以用公钥解密，然而该公钥是服务器一开始通过明文传输给浏览器的，中间人一样可以获取到该公钥来解密服务器传输的数据。这个方案似乎只能保证浏览器向服务器传输数据的安全性（其实仍有问题）。

# 改良非对称加密
基于以上方案，我们很快就能发现既然一对公私钥只能保证一侧的安全，那么我们使用两对公私钥，不就能保证双方通信的安全了吗？

```
服务器持有公钥 A 和私钥 A，浏览器持有公钥 B 和私钥 B
双方通过明文传输各自的公钥
之后浏览器向服务器传输数据都用公钥 A 加密，服务器使用私钥 A 解密
同理服务器向浏览器传输数据都用公钥 B 加密，浏览器使用私钥 B 解密
```

表面上看，这个方案似乎没有问题，但是 HTTPS 并没有采用这种方案，一个原因是因为非对称加密非常耗时，当然另一个原因是该方案有漏洞，这个一会儿再说，我们先来看看应该如何优化该方案。

# 非对称加密+对称加密
既然非对称加密与对称加密相比性能较差，那么我们是否可以将两者结合起来呢？答案是可以！在密钥交换阶段，我们可以使用非对称加密保护通信时使用的对称加密密钥，在数据交换阶段使用对称加密保护传输的内容。

```
服务器有一对公钥 A 和私钥 A
服务器通过明文传输公钥 A 给浏览器
浏览器随机生成一个用于对称加密的密钥 X，使用公钥 A 加密后传给服务器
服务器通过私钥 A 解密得到对称加密的密钥 X
这样双方都持有密钥 X，且第三方不知道，接下来所有的数据传输都可以使用该密钥加密和解密
```

# 中间人攻击
我们刚才提到使用两对公私钥以及后续的优化方案都存在漏洞，这个漏洞就是存在中间人攻击。以优化的方案为例，我们来模拟中间人的操作：

```
服务器有一对公钥 A 和私钥 A
服务器通过明文传输公钥 A 给浏览器
中间人劫持到了公钥 A，保存下来，并把数据包中的公钥 A 替换成自己伪造的公钥 B（它自然有对应的私钥 B）
浏览器随机生成一个用于对称加密的密钥 X，使用公钥 B（浏览器不知道公钥被替换了）加密后传输给服务器
中间人劫持后用私钥 B 解密得到密钥 X，再用公钥 A 加密后传给服务器
服务器使用私钥 A 解密得到密钥 X
```

这样在双方都没有发现的情况下，中间人已经获取到了双方用于通信加密的密钥 X。究其根本，是因为**浏览器无法确认它接收到的公钥是不是服务器自己的**。我们总不能再对公钥进行加密吧，那么又得进行密钥交换，重复之前的步骤并且永远没有尽头。

# 如何证明公钥可信
很多时候证明的源头都是一条条不证自明的“公理”。现实生活中如果想证明某个身份证号一定是某个人的，可以让他出示身份证，我们观察身份证上的照片确实是本人，身份证号也匹配，即可断定身份证号的归属（抛开一些特殊情况，比如伪造证件邢啊、整容哈哈）。在这里，身份证由政府做担保，“公理”也就是“政府机构可信”。

互联网世界也有一个类似的“公理”存在，那就是 CA 机构，CA 机构颁发的“身份证”就是数字证书。网站在使用 HTTPS 之前，需要向 CA 机构申请一个数字证书，数字证书中包含证书持有者的相关信息（国家或地区、组织名称、域名、公钥等），服务器把证书传输给浏览器，浏览器从证书中获取网站的公钥。

# 参考
[彻底搞懂 HTTPS 的加密原理](https://zhuanlan.zhihu.com/p/43789231)