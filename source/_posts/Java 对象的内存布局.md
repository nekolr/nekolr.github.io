---
title: Java 对象的内存布局
date: 2018/6/9 15:27:0
tags: [Java,JVM]
categories: [JVM]
---

在 HotSpot 虚拟机中，对象在内存中存储的布局分为 3 块区域：对象头（Header）、实例数据（Instance Data）和对齐填充（Padding）。  

<!--more-->  

# 对象头

HotSpot 虚拟机的对象头通常包括两部分信息，`Mark Word` 和类型指针。当对象是数组时，另外包含一个数组的长度。  

## Mark Word

第一部分官方称为 `Mark Word`，用于存储对象自身的运行时数据，如哈希码（HashCode）、GC 分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳等，这部分数据的长度在 32 位和 64 位虚拟机（未开启压缩指针）中分别为 32bit 和 64bit。由于 `Mark Word` 的信息与对象自身定义的数据无关，考虑到虚拟机的空间效率，它被设计为非固定的数据结构，它会根据对象的状态复用存储空间，如在 32 位的 HotSpot 虚拟机中，如果对象处于未被锁定的状态，`Mark Word` 的 32bit 空间中，25bit 用于存储对象的哈希码，4bit 用于存储对象的分代年龄，2bit 用于存储锁标志位，1bit 用于存储是否是偏向锁。  

![锁状态 ](https://img.nekolr.com/images/2018/06/18/QyB.png)

## 类型指针

对象头的另一个部分是类型指针，即对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。并不是所有的虚拟机实现都必须在对象头存储类型指针（Java 程序通过栈上的 reference 数据来操作堆上的具体对象，由于虚拟机规范中只规定了一个指向对象的引用，并没有定义这个引用应该使用何种方式去定位、访问堆中的对象的具体位置，所以对象访问方式取决于虚拟机的实现，主流的访问方式有使用句柄和直接指针两种，而使用句柄的方式不需要在对象头中存储类型指针）。  

## 数组长度

如果对象是数组，则对象头中还存储数组的长度。  

# 实例数据

实例数据存储程序代码中定义的各种类型的字段内容，无论是从父类继承的还是在子类中定义的都会记录下来，这部分的存储顺序受到虚拟机分配策略参数（FieldsAllocationStyle）和字段在源码中定义的顺序影响。  

# 对齐填充

对齐填充不是必然存在的，也没有特别的含义，它仅仅起着占位符的作用。HotSpot 虚拟机自动内存管理系统要求对象的起始地址必须是 8 字节的整数倍，换句话说，就是对象的大小必须是 8 字节的整数倍。对象头正好是 8 字节的整数倍（1 倍或 2 倍），因此当对象实例数据部分没有对齐时，需要通过对齐填充来补全。  

# 参考

> 《深入理解 Java 虚拟机:JVM 高级特性与最佳实践》