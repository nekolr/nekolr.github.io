<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/cat192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat72.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat48.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.nekolr.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.15.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":null,"show_result":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="从最简单的单表查询开始，能够更加简单直接地接触到 MySQL 中最基础的一些访问方法，结合 MySQL 的行记录、数据页以及索引结构的知识，在出现性能问题时才可以更有底气地应对。">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 的单表查询">
<meta property="og:url" content="https://blog.nekolr.com/2020/09/04/MySQL%20%E7%9A%84%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2/index.html">
<meta property="og:site_name" content="nekolr&#39;s blog">
<meta property="og:description" content="从最简单的单表查询开始，能够更加简单直接地接触到 MySQL 中最基础的一些访问方法，结合 MySQL 的行记录、数据页以及索引结构的知识，在出现性能问题时才可以更有底气地应对。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-09-04T14:09:00.000Z">
<meta property="article:modified_time" content="2023-03-31T09:54:37.168Z">
<meta property="article:author" content="nekolr">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.nekolr.com/2020/09/04/MySQL%20%E7%9A%84%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blog.nekolr.com/2020/09/04/MySQL%20%E7%9A%84%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2/","path":"2020/09/04/MySQL 的单表查询/","title":"MySQL 的单表查询"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL 的单表查询 | nekolr's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="nekolr's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">nekolr's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱吃咖喱棒的打字员DA☆ZE~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section">Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section">Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section">Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%96%B9%E6%B3%95%EF%BC%88access-method%EF%BC%89"><span class="nav-number">1.</span> <span class="nav-text">访问方法（access method）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#const"><span class="nav-number">1.1.</span> <span class="nav-text">const</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ref"><span class="nav-number">1.2.</span> <span class="nav-text">ref</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ref-or-null"><span class="nav-number">1.3.</span> <span class="nav-text">ref_or_null</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#range"><span class="nav-number">1.4.</span> <span class="nav-text">range</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#index-merge"><span class="nav-number">1.5.</span> <span class="nav-text">index_merge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Intersection"><span class="nav-number">1.5.1.</span> <span class="nav-text">Intersection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Union"><span class="nav-number">1.5.2.</span> <span class="nav-text">Union</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sort-Union"><span class="nav-number">1.5.3.</span> <span class="nav-text">Sort-Union</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#index"><span class="nav-number">1.6.</span> <span class="nav-text">index</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#all"><span class="nav-number">1.7.</span> <span class="nav-text">all</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="nav-number">2.</span> <span class="nav-text">写在最后</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">nekolr</p>
  <div class="site-description" itemprop="description">爱吃咖喱棒的打字员DA☆ZE~</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">130</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/nekolr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nekolr" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:excalibll@163.com" title="E-Mail → mailto:excalibll@163.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.nekolr.com/2020/09/04/MySQL%20%E7%9A%84%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nekolr">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nekolr's blog">
      <meta itemprop="description" content="爱吃咖喱棒的打字员DA☆ZE~">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL 的单表查询 | nekolr's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL 的单表查询
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-04 14:09:00" itemprop="dateCreated datePublished" datetime="2020-09-04T14:09:00+00:00">2020-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>从最简单的单表查询开始，能够更加简单直接地接触到 MySQL 中最基础的一些访问方法，结合 MySQL 的行记录、数据页以及索引结构的知识，在出现性能问题时才可以更有底气地应对。</p>
<span id="more"></span>

<p>在开始之前，首先我们创建一张表，其中 id 列创建聚簇索引，username 和 email 列创建二级索引，code 列创建唯一的二级索引，而 province、city 和 county 这三列创建一个联合索引。接着通过程序插入随机数据 100 万条。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span></span><br><span class="line">(</span><br><span class="line">    id         <span class="type">int</span> auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">    username   <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    code       <span class="type">int</span>          <span class="keyword">null</span>,</span><br><span class="line">    email      <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    avatar     <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    province   <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    city       <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    county     <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">null</span>,</span><br><span class="line">    key idx_username (username),</span><br><span class="line">    <span class="keyword">unique</span> key idx_code (code),</span><br><span class="line">    key idx_email (email),</span><br><span class="line">    key idx_address (province, city, county)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB CHARSET <span class="operator">=</span> utf8;</span><br></pre></td></tr></table></figure>

<h1 id="访问方法（access-method）"><a href="#访问方法（access-method）" class="headerlink" title="访问方法（access method）"></a>访问方法（access method）</h1><p>对于单表来说，MySQL 查询能够执行的方式大致有两种，一种是使用全表扫描，即扫描表的每一行记录，把符合条件的记录加入到结果集中。另一种就是使用索引查询，但是针对索引的查询也细分为很多种，比如针对主键或者唯一二级索引的等值查询，普通二级索引的等值查询，索引列的范围查询等等，这些都是 MySQL 执行查询时的访问方法。</p>
<h2 id="const"><a href="#const" class="headerlink" title="const"></a>const</h2><p>通过主键或者唯一二级索引进行等值查询时使用的就是 const，意为常数级别的访问方法，它的代价几乎可以忽略。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">12286</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+-------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type <span class="operator">|</span>possible_keys<span class="operator">|</span>key    <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+-------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>const<span class="operator">|</span><span class="keyword">PRIMARY</span>      <span class="operator">|</span><span class="keyword">PRIMARY</span><span class="operator">|</span><span class="number">4</span>      <span class="operator">|</span>const<span class="operator">|</span><span class="number">1</span>   <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+-------+-------+-----+----+--------+-----+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> code <span class="operator">=</span> <span class="number">12286</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+--------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type <span class="operator">|</span>possible_keys<span class="operator">|</span>key     <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+--------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>const<span class="operator">|</span>idx_code     <span class="operator">|</span>idx_code<span class="operator">|</span><span class="number">5</span>      <span class="operator">|</span>const<span class="operator">|</span><span class="number">1</span>   <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+--------+-------+-----+----+--------+-----+</span></span><br></pre></td></tr></table></figure>

<p>与主键不同的是，使用唯一二级索引作为查询条件时，如果没有覆盖索引，那么就需要回表。同时由于唯一二级索引并不限制 NULL（没有填充数据）的数量，所以在进行判空查询时无法使用 const，比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> code <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+--------+-------+-----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key     <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+--------+-------+-----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span>idx_code     <span class="operator">|</span>idx_code<span class="operator">|</span><span class="number">5</span>      <span class="operator">|</span>const<span class="operator">|</span><span class="number">4</span>   <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> index <span class="keyword">condition</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+--------+-------+-----+----+--------+---------------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p>通过二级索引进行等值查询时使用的就是 ref，由于索引列的值相同的记录基本上是连续的，因此这种访问方式也是比较快的。但是二级索引的等值查询不是一定使用 ref 的访问方式，这取决于查询条件所匹配到的记录条数，如果匹配到的记录较少，那么回表的代价还是比较低的，此时可以使用 ref 的方式；如果匹配到的记录较多，那么 MySQL 可能会选择使用全表扫描的方式执行查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;Bob&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+------------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key         <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+------------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span>idx_username <span class="operator">|</span>idx_username<span class="operator">|</span><span class="number">303</span>    <span class="operator">|</span>const<span class="operator">|</span><span class="number">1724</span><span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+------------+-------+-----+----+--------+-----+</span></span><br></pre></td></tr></table></figure>

<p>对于包含多个索引列的二级索引（也叫联合索引）来说，只要符合最左匹配原则就可能采用 ref 的访问方式。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> province <span class="operator">=</span> <span class="string">&#x27;山东&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+-----------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key        <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+-----------+-------+-----+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span>idx_address  <span class="operator">|</span>idx_address<span class="operator">|</span><span class="number">303</span>    <span class="operator">|</span>const<span class="operator">|</span><span class="number">1</span>   <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+-----------+-------+-----+----+--------+-----+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> province <span class="operator">=</span> <span class="string">&#x27;山东省&#x27;</span> <span class="keyword">and</span> city <span class="operator">=</span> <span class="string">&#x27;济南市&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+-----------+-------+-----------+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key        <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>        <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+-----------+-------+-----------+----+--------+-----+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span>idx_address  <span class="operator">|</span>idx_address<span class="operator">|</span><span class="number">606</span>    <span class="operator">|</span>const,const<span class="operator">|</span><span class="number">1</span>   <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+-----------+-------+-----------+----+--------+-----+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> city <span class="operator">=</span> <span class="string">&#x27;济南市&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+----+-------+----+------+--------+-----------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span>  <span class="operator">|</span>filtered<span class="operator">|</span>Extra      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+----+-------+----+------+--------+-----------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">ALL</span> <span class="operator">|</span><span class="keyword">NULL</span>         <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="keyword">NULL</span>   <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">989489</span><span class="operator">|</span><span class="number">10</span>      <span class="operator">|</span><span class="keyword">Using</span> <span class="keyword">where</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+----+-------+----+------+--------+-----------+</span></span><br></pre></td></tr></table></figure>

<h2 id="ref-or-null"><a href="#ref-or-null" class="headerlink" title="ref_or_null"></a>ref_or_null</h2><p>有时候我们不仅想找出某个二级索引列的值等于某个常数的记录，还想把该列值为 NULL 的记录也找出来，此时使用的就是 ref_or_null 的访问方法，比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;Bob&#x27;</span> <span class="keyword">or</span> username <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+-------------+------------+-------+-----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type       <span class="operator">|</span>possible_keys<span class="operator">|</span>key         <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+-------------+------------+-------+-----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>ref_or_null<span class="operator">|</span>idx_username <span class="operator">|</span>idx_username<span class="operator">|</span><span class="number">303</span>    <span class="operator">|</span>const<span class="operator">|</span><span class="number">1725</span><span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> index <span class="keyword">condition</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+-------------+------------+-------+-----+----+--------+---------------------+</span></span><br></pre></td></tr></table></figure>

<p>上面的查询相当于分别从索引树中找出 username is null 和 username &#x3D; ‘Bob’ 的两个连续的记录范围，然后根据记录中的主键值回表查询完整的用户记录。</p>
<h2 id="range"><a href="#range" class="headerlink" title="range"></a>range</h2><p>如果使用索引列进行范围查询，一般会使用 range 访问方法。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="keyword">in</span> (<span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+------------+-------+----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type <span class="operator">|</span>possible_keys<span class="operator">|</span>key         <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+------------+-------+----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">range</span><span class="operator">|</span>idx_username <span class="operator">|</span>idx_username<span class="operator">|</span><span class="number">303</span>    <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">3425</span><span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> index <span class="keyword">condition</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+------------+-------+----+----+--------+---------------------+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> code <span class="operator">&gt;=</span> <span class="number">122</span> <span class="keyword">and</span> code <span class="operator">&lt;=</span> <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+--------+-------+----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type <span class="operator">|</span>possible_keys<span class="operator">|</span>key     <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+--------+-------+----+----+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">range</span><span class="operator">|</span>idx_code     <span class="operator">|</span>idx_code<span class="operator">|</span><span class="number">5</span>      <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">179</span> <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> index <span class="keyword">condition</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+--------+-------+----+----+--------+---------------------+</span></span><br></pre></td></tr></table></figure>

<p>从上面的例子看，范围一般有单点区间和连续区间，单点区间只要多次使用索引的等值查询即可，而连续区间则只要找到区间的起始点，之后沿着该点向后顺序查询即可，速度也是比较快的。</p>
<p>总的来说，只要索引列和常数使用比较符号（等于、不等于、大于等于等等），<code>in</code> 和 <code>not in</code>，<code>is null</code> 和 <code>is not null</code>，以及 <code>between</code> 和 <code>like</code> 连接起来就可以产生一个区间，就可以使用 range 访问方法，但是 like 比较特殊，只有符合最左前缀匹配原则时才可以。</p>
<h2 id="index-merge"><a href="#index-merge" class="headerlink" title="index_merge"></a>index_merge</h2><p>有些特殊的查询会在一个查询中使用到多个索引，这种查询使用的访问方法就是 index_merge，即索引合并。索引合并的算法一般有三种：Intersection、Union、Sort-Union。</p>
<h3 id="Intersection"><a href="#Intersection" class="headerlink" title="Intersection"></a>Intersection</h3><p>所谓交集合并就是将从多个索引中查询到的结果取交集，比如下面这个：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;Bob&#x27;</span> <span class="keyword">and</span> email <span class="operator">=</span> <span class="string">&#x27;orghxctxih@cxmxz.gmz&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+----------------------+----------------------+-------+----+----+--------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type       <span class="operator">|</span>possible_keys         <span class="operator">|</span>key                   <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+----------------------+----------------------+-------+----+----+--------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>index_merge<span class="operator">|</span>idx_username,idx_email<span class="operator">|</span>idx_email,idx_username<span class="operator">|</span><span class="number">303</span>,<span class="number">303</span><span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">2</span>   <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> <span class="keyword">intersect</span>(idx_email,idx_username); <span class="keyword">Using</span> <span class="keyword">where</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+----------------------+----------------------+-------+----+----+--------+----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>整个过程就是分别将根据索引列查询得出的结果，然后根据结果中的主键值取交集，最后回表查询。这里我们可能会疑惑为什么不先拿到一个根据索引列查询的结果，然后在它的基础上进行回表查询并过滤第二个条件呢？这其实就要比较两种方式的成本。我们知道，读取二级索引是顺序 I&#x2F;O，而回表有很大可能是随机 I&#x2F;O，虽然使用交集合并的方式需要读取多个二级索引，但是多个索引合并后，交集的记录数一定要比只读取一个索引的记录数要少，需要回表的记录数也少，所以成本更低。</p>
<blockquote>
<p>一个查询使用多个索引列，有时候可能并不会像我们预料的那样使用索引合并，这取决于索引列能够匹配到的记录个数，如果记录数比较少，可能只是单纯的使用 ref 访问方式。</p>
</blockquote>
<p>一般只有在多个二级索引进行等值匹配（联合索引需要每个列都进行匹配，不能只匹配部分列）时才会使用 Intersection 索引合并，但是有些特殊的情况也可以使用，比如在主键列使用范围匹配的时候：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">12205</span> <span class="keyword">and</span> username <span class="operator">=</span> <span class="string">&#x27;Bob&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+--------------------+--------------------+-------+----+----+--------+--------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type       <span class="operator">|</span>possible_keys       <span class="operator">|</span>key                 <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+--------------------+--------------------+-------+----+----+--------+--------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>index_merge<span class="operator">|</span><span class="keyword">PRIMARY</span>,idx_username<span class="operator">|</span>idx_username,<span class="keyword">PRIMARY</span><span class="operator">|</span><span class="number">307</span>,<span class="number">4</span>  <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">852</span> <span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> <span class="keyword">intersect</span>(idx_username,<span class="keyword">PRIMARY</span>); <span class="keyword">Using</span> <span class="keyword">where</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+--------------------+--------------------+-------+----+----+--------+--------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>对于这种特殊情况，我们只要记住一点，即：<strong>二级索引的索引列相同的记录是按照主键排序的</strong>。因此使用主键进行范围查询的结果可以很容易地跟二级索引的等值查询的结果进行取交集。</p>
<h3 id="Union"><a href="#Union" class="headerlink" title="Union"></a>Union</h3><p>与 Intersection 类似的，只不过不再使用 and 取交集，而是使用 or 取并集。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;Bob&#x27;</span> <span class="keyword">or</span> email <span class="operator">=</span> <span class="string">&#x27;orghxctxih@cxmxz.gmz&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+----------------------+----------------------+-------+----+----+--------+------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type       <span class="operator">|</span>possible_keys         <span class="operator">|</span>key                   <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+----------------------+----------------------+-------+----+----+--------+------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>index_merge<span class="operator">|</span>idx_username,idx_email<span class="operator">|</span>idx_username,idx_email<span class="operator">|</span><span class="number">303</span>,<span class="number">303</span><span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">3317</span><span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> <span class="keyword">union</span>(idx_username,idx_email); <span class="keyword">Using</span> <span class="keyword">where</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+----------------------+----------------------+-------+----+----+--------+------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>在拿到两个结果集之后，由于这两个结果集都是按照主键排序的，因此按照主键值进行合并也是比较容易的，只有合并后的结果集也是按照主键排序，回表时才能够降低成本。</p>
<h3 id="Sort-Union"><a href="#Sort-Union" class="headerlink" title="Sort-Union"></a>Sort-Union</h3><p>一般使用 Union 索引合并的条件太苛刻，必须保证每个二级索引都是等值匹配，比如下面这种就无法使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="keyword">in</span> (<span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Alice&#x27;</span>) <span class="keyword">or</span> code <span class="operator">&lt;</span> <span class="number">2205</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+---------------------+---------------------+-------+----+----+--------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type       <span class="operator">|</span>possible_keys        <span class="operator">|</span>key                  <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+---------------------+---------------------+-------+----+----+--------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>index_merge<span class="operator">|</span>idx_code,idx_username<span class="operator">|</span>idx_username,idx_code<span class="operator">|</span><span class="number">303</span>,<span class="number">5</span>  <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">5628</span><span class="operator">|</span><span class="number">100</span>     <span class="operator">|</span><span class="keyword">Using</span> sort_union(idx_username,idx_code); <span class="keyword">Using</span> <span class="keyword">where</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----------+---------------------+---------------------+-------+----+----+--------+----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>这是因为通过这两个索引列匹配到的结果集并不是按照主键排序的，但是我们可以将查询的结果再根据主键进行一次排序，这样就可以使用 Union 的方式进行索引合并。这种将多个根据索引列查询到的结果集进行再次排序，最后取并集的方式就是 Sort-Union。</p>
<h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><p>当我们使用索引覆盖，但需要扫描全部的索引记录时，使用的就是 index 访问方法。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> province, city, county <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> city <span class="operator">=</span> <span class="string">&#x27;青岛市&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+-----------+-------+----+------+--------+------------------------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type <span class="operator">|</span>possible_keys<span class="operator">|</span>key        <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span>  <span class="operator">|</span>filtered<span class="operator">|</span>Extra                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+-----------+-------+----+------+--------+------------------------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span>index<span class="operator">|</span><span class="keyword">NULL</span>         <span class="operator">|</span>idx_address<span class="operator">|</span><span class="number">909</span>    <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">989489</span><span class="operator">|</span><span class="number">10</span>      <span class="operator">|</span><span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index<span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+-----+-------------+-----------+-------+----+------+--------+------------------------+</span></span><br></pre></td></tr></table></figure>

<p>查询的字段都是索引列，因此可以使用覆盖索引，但是由于查询条件不符合最左前缀原则，所以只能对整个索引树（联合索引树）进行扫描，不过这颗树要比聚簇索引“小”很多，所以性能要比直接遍历聚簇索引（全表扫描）要好一些。</p>
<h2 id="all"><a href="#all" class="headerlink" title="all"></a>all</h2><p>all 就是全表扫描，也就是直接遍历聚簇索引，比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> avatar <span class="operator">=</span> <span class="string">&#x27;https://avatar.github.com/cjFQDo&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+----+-------+----+------+--------+-----------+</span></span><br><span class="line"><span class="operator">|</span>id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span> <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span><span class="keyword">rows</span>  <span class="operator">|</span>filtered<span class="operator">|</span>Extra      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+----+-------+----+------+--------+-----------+</span></span><br><span class="line"><span class="operator">|</span><span class="number">1</span> <span class="operator">|</span>SIMPLE     <span class="operator">|</span><span class="keyword">user</span>  <span class="operator">|</span><span class="keyword">NULL</span>      <span class="operator">|</span><span class="keyword">ALL</span> <span class="operator">|</span><span class="keyword">NULL</span>         <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="keyword">NULL</span>   <span class="operator">|</span><span class="keyword">NULL</span><span class="operator">|</span><span class="number">989489</span><span class="operator">|</span><span class="number">10</span>      <span class="operator">|</span><span class="keyword">Using</span> <span class="keyword">where</span><span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--+-----------+------+----------+----+-------------+----+-------+----+------+--------+-----------+</span></span><br></pre></td></tr></table></figure>

<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>很多时候查询优化器并不会按照我们预想的方式进行查询，这都是基于查询成本考量下的结果。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/09/03/GC%20%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/" rel="prev" title="GC 日志分析">
                  <i class="fa fa-chevron-left"></i> GC 日志分析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/09/07/MySQL%20%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%8E%9F%E7%90%86/" rel="next" title="MySQL 连接的原理">
                  MySQL 连接的原理 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nekolr</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","mhchem":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
